
Универсальными коллекциями называют все коллекции, поддерживающие оператор `Для каждого .. из` и имеющие один и тот же минимальный набор свойств и методов. Другими словами Универсальная коллекция — это интерфейс взаимодействия, описывающий общий функционал любой коллекции.

Типы универсальных коллекций:

- [[#Массивы|Массив]]
- [[#Структуры|Структура]]
- [[#Соответствие|Соответствие]]
- [[#Список значений|СписокЗначений]]
- [[#Таблица значений|ТаблицаЗначений]]
- [[#Дерево значений|ДеревоЗначений]]

### Общие свойства универсальных коллекций



### Общие методы универсальных коллекций



>Индексация в коллекциях 1С начинается с 0

==ВЫНЕСТИ СПИСКИ МЕТОДОВ В ОТДЕЛЬНЫЙ ОБЩИЙ СПИСОК. КОЛЛЕКЦИИ РЕАЛИЗУЮТ ЕДИНЫЙ ИНТЕРФЕЙС, ПОЭТОМУ ПОВТОРЯТЬ ОДНО И ТО ЖЕ НЕ КАМЕЛЬФО==

# Структуры

**Доступность:** `&НаКлиенте`, `&НаСервере`, `Толстый и тонкий клиент` (на формах недостуно)

Представляет собой неупорядоченный словарь, набор пар `ключ-значение`, который логически представляет собой набор именованных параметров (структуру). Элементы имеют тип `КлючИЗначение`

#### Примеры использования

```bsl
МояСтруктура = Новый Структура;
МояСтруктура.Вставить("Номер", 121233);
МояСтруктура.Вставить("Дата", ТекущаяДата());

// ИЛИ

МояСтруктура = Новый Структура("Номер, Дата");
МояСтруктура["Номер"] = 666;
МояСтруктура.Дата = ТекущаяДата();
МояСтруктура[1] = ТекущаяДата(); // ОШИБКА, Получение элемента по индексу не определено

// ИЛИ

МояСтруктура = Новый Структура("Номер, Дата", 121233, ТекущаяДата());
```

Имя Ключа структуры не может начинаться с цифры.

Можно пропускать инициализацию некоторых параметров структуры при объявлении:

```bsl
КлючиИЗначения = новый Структура("Имя, Пол, ГодРождения", "Саша", , 2002);
// Пол данного человека = неопределено, то есть это квир или гермофродит
```

Обход структуры как коллекции

```bsl
Для каждого элемент из МояСтруктура Цикл
    ОбщегоНазначения.СообщитьПользователю(Строка(элемент.Ключ) + " = " + элемент.Значение);
КонецЦикла;
```

### Устройство типа "Структура"

#### Свойства

**`КлючИЗначение`** — элемент структуры

- **КлючИЗначение.Ключ** — строковый идентификатор значения в словаре
- **КлючИЗначение.Значение** — ну как-бы все и так ясно...

#### Методы

* **`Свойство("ИмяКлюча", <НайденноеЗначение>)`** — поиск указанного ключа в структуре. Если найден — возвращает `Истина` и `<НайденноеЗначение>` по этому ключу инициализируется. Если не найден — возвращается ложь и `<НайденноеЗначение>` становится `неопределено`.
* **`Количество()`**
* **`Очистить()`** — удаление всех элементов
* **`Вставить(ключ, значение)`** — добавляет или заменяет значение с заданным ключом
* **`Удалить(ключ)`** — удаляет элемент по ключу

# Соответствие

**Доступность:** `&НаКлиенте`, `&НаСервере`

Представляет собой классический словарь, где ключ может иметь любой тип (Число, Строка, Ссылка). Элементы имеют тип `КлючИЗначение`

#### Примеры использования

```bsl
словарь = Новый Соответствие;
словарь.Вставить(Дата(2017,12,1), "Число 2");
словарь.Вставить(Дата(2017,12,2), "Число 3");
словарь.Вставить(Дата(2017,12,3), "Число 1");
```

### Устройство типа "Соответствие"

#### Методы

- **`Вставить(ключ, значение)`**
- **`Удалить(ключ)`**
- **`Получить(ключ)`** — возвращает значение по ключу. Если указанного ключа не существует, возвращает `неопределено`
- **`Количество()`**
- **`Очистить()`**

# Массивы

**Доступность:** `&НаКлиенте (толстый и тонкий)`, `&НаСервере`

Упорядоченный набор элементов, доступных по индексу, начинающегося с нуля.

#### Примеры использования

```bsl

пустойМассив = Новый Массив();

обычныйМассив = Новый Массив(4);
// или
обычныйМассив = Новый Массив("4");

двумерныйМассив = Новый Массив(2, 4);

обычныйМассив[0] = 1;
обычныйМассив[1] = "Второй элемент";

двумерныйМассив[0][1] = 28;

Для каждого элемент из обычныйМассив Цикл
    ОбщегоНазначения.СообщитьПользователю(элемент);
КонецЦикла;
```

При ининциализации массива все его элементы принимают значение `неопределено`

Многомерный массив содержит элементы типа `Массив`

Фиксированный массив:

```
ФиксированныеЧисла = Новый ФиксированныйМассив(МассивЧисел);

// Получился константный массив на основе обычного:
//    нельзя менять значения имеющихся элементов
//    нельзя добавлять новые элементы
//    нельзя удалять имеющиеся элементы
```

### Устройство типа "Массив"

Упорядоченная FIFO-последовательность элементов произвольного типа

Свойства:

* *`Индекс`* — номер значения
* *`Значение`* — значение, ассоциированное с указанным индексом

#### Методы

- **`Количество()`** — количество элементов в массиве
- **`ВГраница()`** — наибольший индекс в массиве, то есть `Количество() - 1`
- **`Добавить([значение])`** — увеличение массива, путем добавления нового элемента в конец
- **`Вставить(индекс, [значение])`** — добавление элемента в указанную позицию
- **`Удалить(индекс)`** — удаляет элемент из массива
- **`Очистить()`** — удаление всех элементов
- **`Найти(значение)`** — поиск элемента. Если найден — возрват индекса, иначе `неопределено`
- **`Получить(индекс)`** — аналог **`<массив>[индекс]`**
- **`Установить(индекс, значение)`** — аналог **`<массив>[индекс] = значение`**

# Список значений

**Доступность:** `&НаКлиенте (толстый и тонкий)`, `&НаСервере`, **`На форме`**

Расширенный аналог массива. Элемент списка значений имеет тип `ЭлементСпискаЗначений`.

#### Примеры использования

```bsl
Список = Новый СписокЗначений;
Список.Добавить(100, «Число 100»);
Список.Добавить(10, «Число 10»);
Список.Вставить(0, 1000, «Число 1000»);

// Порядок: 1000, 100, 10

ПервыйЭлемент = Список[0];

// ИЛИ:

ПервыйЭлемент = Список.Получить(0);
```

Добавление картинки:

```bsl
СписокДней = новый СписокЗначений;
СписокДней.Добавить("Пн", "Понедельник", , БиблиотекаКартинок.АктивироватьЗадачу);
```

### Устройство типа "СписокЗначений"

**Структура элемента списка значений:**

- *`Индекс`* — начинается с 0
- `Значение` (произвольного типа)
- `Представление` (Строка или ФорматированнаяСтрока) — текст для пользователя, представляющий текущий элемент
- `Пометка` (булево, для общего назначения)
- `Картинка` (тип Картинка) — хранит файл изображения

**Методы элемента:**

- `ПолучитьИдентификатор()` — возвращает ID элемента. ID не зависит от позиции в списке

#### Свойства

- **`ДоступныеЗначения`** — `СписокЗначений`, который содержит множество всех допустимых значений в списке.
- **`ТипЗначения`** (`ОписаниеТипов`) — задает допустимый тип для элементов списка

#### Методы

- **`Добавить(значение, представление, пометка, картинка)`** — добавление элемента в конец
- **`Вставить(индекс, значение, ...)`** — добавление элемента в указанную позицию
- **`ЗагрузитьЗначения(массив)`** — загружает значения из указанного массива
- **`Удалить(элементИлиИндекс)`** — индекс элемента (`Число`) или `ЭлементСпискаЗначений`
- **`Количество()`**
- **`Индекс(ЭлементСпискаЗначений)`** — поиск элемента в списке и возвращение его индекса. Возвращается -1 в случае неудачного поиска
- **`Скопировать()`** — создание копии списка значений
- **`СортироватьПоЗначению(НаправлениеСортировки)`** — сортировка по `Значение` в указанном направлении (`НаправлениеСортировки.Возр`, `НаправлениеСортировки.Убыв`)
- **`СортироватьПоПредставлению(НаправлениеСортировки)`** — сортировка по `Представление` в указанном направлении

На форме `СписокЗначений` отображается подобно табличной части, но без заголовков и визуальных границ. Пользователь может сам выбрать тип элемента списка значений и выбрать конкретное значение из предложенного списка.

# Таблица значений

**Доступность:**`&НаСервере`, `&НаКлиенте (только на толстом)`, `На форме`

Представляет собой массив однотипных объектов или, другими словами, таблицу с определенными столбцами (свойствами). Коллекция является довольно ресурсоемкой, поэтому она недоступна на клиенте

#### Примеры использования

```bsl
Таб = Новый ТаблицаЗначений;

Таб.Колонки.Добавить("Фрукт"); // регистрация новых столбцов, или, другими словами,
Таб.Колонки.Добавить("Цвет");  // регистрация свойств объектов в коллекции
Таб.Колонки.Добавить("Вкус");

// Добавление строк

Стр = Таб.Добавить(); // инициализация новой строки (объекта)
Стр.Фрукт = "Яблоко"; // заполнение свойств объекта
Стр.Цвет = "Зелёный";
Стр.Вкус = "Кислый";

Стр = Таб.Добавить();
Стр.Фрукт = "Слива";
Стр.Цвет = "Синий";
Стр.Вкус = "Терпкий"; 

// Добавление колонок с описанием типов и заголовком

ОписаниеВеса = Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(12, 3));

Таб.Колонки.Добавить("ВесФрукта", ОписаниеВеса, "Вес фрукта");
Таб[0].ВесФрукта = 100.005;
Таб[1].ВесФрукта = 60.010;

Для Каждого Колонка Из Таб.Колонки Цикл
    ОбщегоНазначения.СообщитьПользователю(Колонка.Имя);
КонецЦикла;

// Все значения колонки Фрукт помещаются в массив
МассивФруктов = Таб.ВыгрузитьКолонку("Фрукт");

// Получение значений для колонки из массива
Таб.ЗагрузитьКолонку(новыеФрукты, "Фрукт");

// обнулим вес во всех строках
Таб.ЗаполнитьЗначения(0, "ВесФрукта");
```

Колонки имеют тип `КоллекцияКолонокТаблицыЗначений`. Элемент колонки имеет тип `КолонкаТаблицыЗначений`.

### Устройство типа "ТаблицаЗначений"

#### Свойства

- `Индексы` — (Тип: `ИндексКоллекции`) коллекция индексов поиска для ускорения поиска значений
    - `Добавить(именаКолонок)` — создает индекс для указанных колонок
    - `Количество()`
    - `Очистить()`
    - `Удалить(индекс)` — удаление индекса по числовому индексу индекса или по ссылке на индекс (да, хрен разберешся)

- `Колонки` — представитель типа `КоллекцияКолонокТаблицыЗначений`. Обладает стандартными методами по работе с коллекцией (`Найти`, `Добавить`, `Вставить`, `Количество`, `Удалить`...)
- *`Строки`* — все строки таблицы, доступ к строкам осуществляется так: `ТЗ[индексСтроки] = ...`. Строки имеют тип `СтрокаТаблицыЗначений`

`КолонкаТаблицыЗначений` — специальный тип, представляющий одну колонку ТЗ

- `Заголовок` — текст для визуального отображения колонки
- `Имя` — идентификатор колонки
- `ТипЗначения` — (Тип: `ОписаниеТипов`) представляет собой инфу о типе колонки
- `Ширина` — (Тип: `Число`) ширина колонки в символах

#### Методы

- `Добавить()` — Добавление строки в конец. Возвращает ссылку на последнюю строку ТЗ
- `Вставить(индекс)` — Добавление строки в указанную позицию
- `ЗаполнитьЗначения(значение, [колонки])` — Заполняет все строки ТЗ указанным значением. При указании списка колонок (в формате `"Колонка1, Колонка2, Колонка3, ..."`) заполняет значения всех полей строк только для указанных колонок
- `ЗагрузитьКолонку(массивЗначений, колонка)` — заполняет все поля в данной колонке данными из массива. В качестве колонки можно указать индекс колонки, имя или ссылку на колонку (`КолонкаТаблицыЗначений`)
- `ВыгрузитьКолонку(колонка)` — Массив полей указанной колонки. Можно указать индекс, имя или ссылку на колонку
- `Скопировать()` — Дублирование текущей строки
- `СкопироватьКолонки([именаКолонок])` — ТаблицаЗначений, полученная копированием только определенных колонок из текущей ТЗ. Если не указывать имена колонок, будет скопирована вся ТЗ
- `Получить()` — Аналог оператора `ТЗ[]`
- `Свернуть(именаКолонокГруппирования, [именаКолонокСуммирования])` — группировка по колонкам группирования с опциональным суммированием других колонок. Списки колонок не должны пересекаться
- `Сдвинуть(строка, смещение)` — Сдвиг строки на указанное число позиций вниз (`+смещение`) или вверх (`-смещение`). Можно передавать индекс строки или ссылку на нее.
- `Итог(имяКолонки)` — Попытка суммирования всех числовых значений в столбце. Если в столбце несколько типов, то они будут преобразовываться к Числу, если среди полей в колонке есть числа, то преобразований не будет, если чисел нет, итог будет `неопределено`
- `Индекс(строка)` — Индекс текущей строки в ТЗ или `-1`, если строка не найдена
- `Найти(значение, [именаКолонок])` — поиск значения ячейки ТЗ среди всей ТЗ или среди указанных колонок
- `НайтиСтроки(параметрыПоиска)` — поиск массива строк, удовлетворяющим параметрам поиска. ПараметрыПоиска — это Структура, где ключом является имя колонки, а значением — искомое значение
- `Сортировать(именаКолонок, [объектСравнения])` — Сортировка по указанным, через запятую, колонкам. После каждого имени колонки можно указать порядок сортировки: Возр или Убыв (Asc или Desc). объектСравнения — это инфа о способе сравнения при сортировке
- `ВыбратьСтроку()` — **Не использовать**. Работает только на толстом клиенте, открывает модальное окно для выбора строки из ТЗ
- `Удалить(строка)` — Удаление строки по индексу или по ссылке на строку
- `Очистить()` — Очищение коллекции

### Поиск по таблице значений

Чтобы ускорить поиск по таблице значений можно создать индекс для указанной колонки, который позволит значительно ускорить процесс поиска

```bsl
// Создание составного индекса по нескольким колонкам
ТаблицаЗначений.Индексы.Добавить("Колонка1, Колонка2, ...");
```

`.Загрузить(<ТаблицаЗначений>)` позволяет инициализировать ТЗ на основе другой ТЗ ??????? шо, я не нашел такого мтеода

> В рамках одной колонки тип ячейки таблицы может быть разным, но если указано ОписаниеТипов для колонки, то тип должен быть представителем семейства описанного типа, то есть если Колонка имеет тип СправочникСсылка, то в этой колонке могут быть ячейки только со ссылками на справочники

Использование ТЗ в запросе

Сформированную в коде таблицу значений, можно передать в качестве параметра в запрос. Запрос затем можно будет выполнить. Чтобы использовать ТЗ как параметр запроса нужно следовать следующему алгоритму:

1. Составить запрос на получение нужных данных. При этом нужно создать временную таблицу, которая по структуре соответствует рассматриваемой ТаблицеЗначений.
2. Заполнить ТаблицуЗначений
3. Установить параметр в запросе (в коде запроса `&ТЗкакПараметр` и в коде 1С `Запрос.УстановитьПараметр("ТЗкакПараметр", МояТЗ)`)
4. Выполнить запрос

>Столбцы временной таблицы запроса и ТаблицыЗначений должны совпадать по названию и типу. Если при создании колонок ТаблицыЗначений типы указаны не были, то запрос выполниться не сможет

Пример:

```bsl
<ПРИМЕР КОДА С ИСПОЛЬЗОВАНИЕМ ЗАПРОСА И ТЗ КАК ПАРАМЕТРА>
```

>Таблицу значений можно получить на основе выполненного запроса. При этом будет получена готовая, типизированная таблица значений, в которой будут созданы все колонки, которые есть в итоговой выборке запроса

```bsl
Запрос = Новый Запрос;
Запрос.Текст =
    "ВЫБРАТЬ
    |	ОбновлениеИнформационнойБазы.Ссылка КАК Ссылка
    |ИЗ
    |	ПланОбмена.ОбновлениеИнформационнойБазы КАК ОбновлениеИБ
    |ГДЕ
    |	ОбновлениеИнформационнойБазы.Временная = ЛОЖЬ";
РезультатЗапроса = Запрос.Выполнить();
ТЗ = РезультатЗапроса.Выгрузить();
```

## Пример заполнения вложенной ТЗ


```bsl
ВнешняяТаблица = Новый ТаблицаЗначений; 
ВнешняяТаблица.Колонки.Добавить("Реквизит1_1", Новый ОписаниеТипов("Строка"));
ВнешняяТаблица.Колонки.Добавить("Реквизит1_2", Новый ОписаниеТипов("ТаблицаЗначений")); 

СтрокаВнешнейТаблицы = ВнешняяТаблица.Добавить();
СтрокаВнешнейТаблицы.Реквизит1_1 = "1";
СтрокаВнешнейТаблицы.Реквизит1_2.Колонки.Добавить("Реквизит2_1", Новый ОписаниеТипов("Строка"));
СтрокаВнешнейТаблицы.Реквизит1_2.Колонки.Добавить("Реквизит2_2", Новый ОписаниеТипов("Булево"));
СтрокаВнутреннейТаблицы = СтрокаВнешнейТаблицы.Реквизит1_2.Добавить();
СтрокаВнутреннейТаблицы.Реквизит2_1 = "1.1";
СтрокаВнутреннейТаблицы.Реквизит2_2 = Ложь;
```

[Программное создание реквизитов, в том числе вложенных ТЗ](https://forum.infostart.ru/forum9/topic139260/)

[Вложенные ТЗ](https://forum.infostart.ru/forum9/topic186754/)

Подгон от жпт:

```bsl
&НаСервере
Процедура ПриОткрытииФормы(Отказ, СтандартнаяОбработка)
// Создаем таблицу значений
ТаблицаЗначений = Новый ТаблицаЗначений;
ТаблицаЗначений.Колонки.Добавить("Число1", Новый ОписаниеТипов("Число"));
ТаблицаЗначений.Колонки.Добавить("Число2", Новый ОписаниеТипов("Число"));
ТаблицаЗначений.Колонки.Добавить("ВложеннаяТаблица", Новый ОписаниеТипов("ТаблицаЗначений"));

// Заполняем таблицу значений
Для НомерСтроки = 0 По 9 Цикл
НоваяСтрока = ТаблицаЗначений.Добавить();
НоваяСтрока.Число1 = НомерСтроки * 10;
НоваяСтрока.Число2 = НомерСтроки * 20;

// Создаем вложенную таблицу значений
ВложеннаяТаблица = Новый ТаблицаЗначений;
ВложеннаяТаблица.Колонки.Добавить("Число11", Новый ОписаниеТипов("Число"));
ВложеннаяТаблица.Колонки.Добавить("Число22", Новый ОписаниеТипов("Число"));
ВложеннаяТаблица.Колонки.Добавить("Число33", Новый ОписаниеТипов("Число"));

// Заполняем вложенную таблицу
Для НомерВложеннойСтроки = 0 По 2 Цикл
ВложеннаяСтрока = ВложеннаяТаблица.Добавить();
ВложеннаяСтрока.Число11 = НомерВложеннойСтроки + 1;
ВложеннаяСтрока.Число22 = (НомерВложеннойСтроки + 1) * 2;
ВложеннаяСтрока.Число33 = (НомерВложеннойСтроки + 1) * 3;
КонецЦикла;

НоваяСтрока.ВложеннаяТаблица = ВложеннаяТаблица;
КонецЦикла;

// Присваиваем заполненную таблицу значений элементу формы
ЗначениеВДанныеФормы(ТаблицаЗначений, элементы.ТаблицаЗначений);
КонецПроцедуры
```

Из офф. доков:

```bsl
/ Создание таблицы значений 
ТаблицаЗначений = Новый ТаблицаЗначений;
// добавим в таблицу значений три колонки

ТаблицаЗначений.Колонки.Добавить("Отдел",,"Отдел");
ТаблицаЗначений.Колонки.Добавить("Сотрудник",,"Фамилия сотрудника");
ТаблицаЗначений.Колонки.Добавить("Оклад",,"Оклад");

// добавим строку

Стр=ТаблицаЗначений.Добавить();
Стр.Отдел="Отдел 1";
Стр.Сотрудник="Иванов";
Стр.Оклад=5600;

// добавим новую колонку

ТаблицаЗначений.Колонки.Добавить("Стаж",,"Стаж работы");
// ввод новой строки и данных по строке

ТекСтр = ТаблицаЗначений.Добавить();
ТекСтр.Отдел = "Отдел 2";
ТекСтр.Сотрудник = "Петров";
ТекСтр.Оклад = 6700;ТекСтр.Стаж = 22;
```

# Дерево значений

**Доступность:** `&НаКлиенте`, `&НаСервере`

Аналог типа `ТаблицаЗначений`, организованный в виде двухсвязного дерева. У каждого элемента коллекции есть ссылка на родительский элемент `СтрокаДереваЗначений`.

>Уровни дерева нумеруются с 0

#### Примеры использования



### Структура типа "ДеревоЗначений"

#### Свойства

- **`Колонки`** — такие же колонки, как и в таблице значений
- **`Строки`** — Тип: `КоллекцияСтрокДереваЗначений`; коллекция всех строк на текущем уровне, аналог типа `ТаблицаЗначений`, но без метода `Свернуть()`. У каждой строки есть свойство `Родитель`, представляющее ссылку на родительский элемент. Оно может быть не заполнено

**Свойства элемента коллекции `СтрокаДереваЗначений`:**

- **`Родитель`**
- **`Строки`**

Методы элемента коллекции:

- **`Владелец()`** — Получает ссылку на дерево значений, которое содержит этот элемент
- **`Получить()`** — Аналог оператора `[]`
- **`Уровень()`** — Получает уровень строки в дереве. Если свойство `Родитель = неопределено`, тогда возвращается 0
- **`Установить(индекс, значение)`** — Аналог оператора `[]`

#### Методы (2)

- **`ВыбратьСтроку(заголовокОкна, начальнаяСтрока)`** — Открытие диалогового окна для пользовательского выбора элемента дерева. `начальнаяСтрока` — ссылка на строку ДЗ, которая будет выделена при открытии диалогового окна
- **`Скопировать()`** — Создание полной копии ДереваЗначений

Далее: [[Коллекции на формах|Коллекции на формах]]

#1С #1С/Язык_программирования #1С/Язык_программирования/Коллекции