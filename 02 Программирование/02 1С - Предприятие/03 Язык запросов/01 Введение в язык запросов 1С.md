
Язык запросов 1С представляет собой урезанное подобие языка SQL, а именно оператора SELECT. Но при этом, у языка запросов 1С есть некоторые свои дополнения

[Про язык запросов](https://v8.1c.ru/platforma/mehanizm-zaprosov/)
[Полезное про Подобно, ВИЕРАРХИИ](https://wiseadvice-it.ru/o-kompanii/blog/articles/yazyk-zaprosov-1s-8-3/)
Источники и темы для изучения:

1. [Офф сайт](https://its.1c.ru/db/metod8dev/content/2590/hdoc)
2. [helpme1s.ru (Типы соединений)](https://helpme1s.ru/soedineniya-v-zaprosax-v-1s-8-v-primerax)
3. [helpme1s.ru (Упорядочивание)](https://helpme1s.ru/uporyadochivanie-v-zaprosax-v-1s-8-v-primerax)
4. [Wise advice](https://wiseadvice-it.ru/o-kompanii/blog/articles/yazyk-zaprosov-1s-8-3/)
5. СрезПоследних()

>Регистр текста не учитывается в коде языка запросов, кроме псевдонимов полей выборки

Основные операторы:

| Оператор                                                                                                              | Аналог в SQL                                                 |
| :-------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| `ВЫБРАТЬ`                                                                                                             | `select`                                                     |
| `ИЗ`                                                                                                                  | `from`                                                       |
| `ГДЕ`                                                                                                                 | `where`                                                      |
| `ПЕРВЫЕ N`                                                                                                            | `top N`                                                      |
| `РАЗЛИЧНЫЕ`                                                                                                           | `distinct`                                                   |
| `ИТОГИ ПО` [[01 Введение в язык запросов 1С#Итоги\|↪]]                                                                             |                                                              |
| `УПОРЯДОЧИТЬ ПО... [ВОЗР / УБЫВ]` [[01 Введение в язык запросов 1С#Сортировка\|↪]]                                                 | `order by ... [asc / desc]`                                  |
| `СГРУППИРОВАТЬ ПО` [[01 Введение в язык запросов 1С#Группировка\|↪]]                                                               | `group by`                                                   |
| `ЛЕВОЕ / ПРАВОЕ / ВНУТРЕННЕЕ / ПОЛНОЕ СОЕДИНЕНИЕ ... ПО <выраж1> = <выраж2>` [[01 Введение в язык запросов 1С#Типы соединений\|↪]] | `left / right / inner / outer join ... on <expr1> = <expr2>` |
| `ПОМЕСТИТЬ`                                                                                                           | помещение выборки во временную таблицу                       |
| `ПОДОБНО`                                                                                                             | `like`                                                       |

**Более подробно в синтаксической [[Синтаксическая таблица языка запросов 1С|таблице]]**

Синтаксис (может отличаться в разных версиях):

```
// Условные обозначения

<СложныйОбъект> ::= (выражение)
[Необязательно]
| (ИЛИ)
```

```bsl
ВЫБРАТЬ * ИЗ Справочник.Контрагенты // выбор всех столбцов
// * не работает для виртуальных таблиц

<Запрос> ::= 
    ВЫБРАТЬ [ПЕРВЫЕ <число>] [РАЗРЕШЕННЫЕ] [РАЗЛИЧНЫЕ]
    
    <Выражение> [[КАК] <псевдоним>] [, <Выражение> ...]
    
    [ИЗ <ИсточникДанных>[, <ИсточникДанных> ...]]
    [ГДЕ <Условие>]
    
    [ОБЪЕДИНИТЬ [ВСЕ] <Запрос>]
    [УПОРЯДОЧИТЬ ПО <Выражение>[, <Выражение> ...]]
    [СГРУППИРОВАТЬ ПО <Выражение>[, <Выражение> ...]]
    
    [ИТОГИ ПО <Выражение>[, <Выражение> ...]]
    [ИТОГИ ПО ВСЕМУ <Выражение>[, <Выражение> ...]]
    [ИТОГИ ПО ВСЕМУ С <Выражение>[, <Выражение> ...]]
    [ПОМЕСТИТЬ <ИмяВременнойТаблицы>]           //создание временной таблицы
    
    [ИМЕЮЩИЕ <Условие>]
    [ДЛЯ ИЗМЕНЕНИЯ]          // ПРОВЕРИТЬ
    [УСТАНОВИТЬ <Выражение>] // ПРОВЕРИТЬ

    // Выражение: поле, функция, константа, запрос, результат операций
    // Арифметические операторы: + - * /
    //    % не поддерживается в языке запросов
    //    + может использоваться для конкатенации строк
    //      (нельзя использовать для виртуальных полей)
    // Логические операторы: И ИЛИ НЕ = <> > < >= <=  ЕСТЬ NULL (IS NULL) В (IN)
    
    // Агрегатные функции:
    СУММА() | МАКСИМУМ() | МИНИМУМ() | СРЕДНЕЕ() | КОЛИЧЕСТВО()
    | ПОЛЬЗОВАТЕЛЬСКАЯ_ФУНКЦИЯ()

<Соединение> ::= 
    <Выборка> [ВНУТРЕННЕЕ | ЛЕВОЕ | ПРАВОЕ | ПОЛНОЕ] СОЕДИНЕНИЕ <Выборка> ПО <Условие>
```

[Оператор В / НЕ В](https://its.1c.ru/db/metod8dev/content/2499/hdoc)

## Оператор `ВЫБРАТЬ`

#Syntax/1С/Выбрать #Syntax/1С/Из

Выбирает поля из указанной выборки. **Выборкой** может быть любая таблица, табличная часть, поле, константа, выражение, результат соединения/объединения нескольких выборок.

#Syntax/1С/Как

Ключевое слово `КАК` позволяет определить псевдоним для поля. Не является обязательным. Можно указывать псевдоним сразу после идентификатора поля:
```bsl
ВЫБРАТЬ
      Ссылка Документ,  
      Ответственный МатериальноОтветственный  
ИЗ Документ.АвансовыйОтчет

// Аналогично:

ВЫБРАТЬ
      Ссылка КАК Документ,  
      Ответственный КАК МатериальноОтветственный  
ИЗ Документ.АвансовыйОтчет
```

Можно не использовать оператор `ИЗ` при указании полного пути полей:

```bsl
ВЫБРАТЬ ПЕРВЫЕ 3
     Справочник.Номенклатура.Код,  
     Справочник.Номенклатура.Наименование
```

Запрос с оператором `ИЗ`:

```bsl
ВЫБРАТЬ РАЗЛИЧНЫЕ
    Изделия.Ссылка,
    Изделия.Количество,
    Изделия.Тип
ИЗ
    Справочник.Изделия как Изделия
```

Выбор полей сложного объекта (например, табличной части):

```bsl
// Получение нескольких колонок табличной части как вложенной таблицы  
ВЫБРАТЬ Номер, Дата, Товары.(Номенклатура, Количество)
ИЗ Документ.АвансовыйОтчет
```

Можно назначать псевдонимы для вложенных полей и для самой табличной части:

```bsl
ВЫБРАТЬ Документ.АвансовыйОтчет.Товары.(
    Номенклатура,
    Сумма КАК СуммаПоСтроке
) как ТоварыОтчета
```

### Литералы в запросах

| Литерал                                            | Описание                                                                       |
| -------------------------------------------------- | ------------------------------------------------------------------------------ |
| `15, 1.2`                                          | число                                                                          |
| `"текст"`                                          | строка ограниченной длины. Строки неограниченной длины не могут использоваться |
| `Истина, Ложь`                                     | булево                                                                         |
| `NULL`                                             | отсутствие значения                                                            |
| `Неопределено`                                     |                                                                                |
| `ДАТАВРЕМЯ(год, месяц, день)`                      | возвращает литерал типа Дата                                                   |
| `ДАТАВРЕМЯ(2003, 10, 12, 10, 15, 34)`              |                                                                                |
| `(..Договор.ПустаяСсылка, Неопределено, NULL, "")` | СписокЗначений (возможно использование оператора `В`, `НЕ В`)                  |

### Функция `ВЫРАЗИТЬ()`

>Строки неограниченной длины не могут быть обработаны в запросах 1С:Предприятия при сравнении значений, группировке и если требуется получить `РАЗЛИЧНЫЕ`. Чтобы обойти эти ограничения нужно преобразовать неограниченную строку к ограниченной. Для этого можно использовать функцию **`ВЫРАЗИТЬ()`**

**`ВЫРАЗИТЬ(переменная КАК СТРОКА(длинаСтроки))`** — Не является функцией преобразования из одного типа в другой. Переменная может менять только параметры типа. Для строки — это длина, для числа — это длина и точность

```bsl
ВЫБРАТЬ
    Ссылка,
    Номенклатура,
    ВЫРАЗИТЬ(Сумма / 3 КАК Число(5,2)) КАК ТретьСуммы
ИЗ Документ.АвансовыйОтчет.Товары
```

Функция выразить используется для:
- Изменения длины строки
- Преобразования строки неограниченной длины к фиксированной строке
- Округления чисел до определенного знака (`ВЫРАЗИТЬ(10/3 КАК ЧИСЛО(12,2))`)
- Преобразования поля составного типа в поле одного типа. Если поле составного типа будет иметь не тот тип, с которым идет сравнение, то будет возвращен `NULL` (`ВЫРАЗИТЬ(Продажи.Регистратор КАК Документ.Реализация)`)

#### Оператор включения `В`

```bsl
(<выражение1>[, <выржаение2>, ...]) В <СписокЗначений>
```

Возвращает `Истина`, если все перечисленные выражения содержаться в СпискеЗначений. Запрос также является СпискомЗначений

Допустим, есть такой абстрактный пример:

```bsl
(<Выражение 1>, ..., <Выражение N>) В (
    ВЫБРАТЬ <Колонка 1>, ..., <Колонка N>
    ИЗ <Источники>
    ГДЕ <Условие>
)
```

Аналогичный запрос на языке SQL:

```bsl
EXISTS(
    SELECT 1 FROM <Источники>
    WHERE (<Условие>) 
        AND <Выражение 1> = <Колонка 1>
        AND ...
        AND <Выражение N> = <Колонка N>
)
```

## Параметры запросов

Параметрами представляют, подставляемые в запрос, выражения.

`&Параметр`

```
ВЫБРАТЬ
    Изделия.Ссылка,
    Изделия.Количество,
    Изделия.Тип
ИЗ
    Справочник.Изделия как Изделия
ГДЕ
    Изделия.Количество > &КоличествоИзделий // Параметр
```

Можно задать источник запроса как параметр:

```
ВЫБРАТЬ
	ТаблицаТоваров.Контрагент КАК Контрагент,
	ТаблицаТоваров.Номенклатура КАК Номенклатура,
	ТаблицаТоваров.Количество КАК Количество,
	ТаблицаТоваров.Сумма КАК Сумма
ИЗ
	&ТаблицаТоваров КАК ТаблицаТоваров
```

>Уровень ссылочной вложенности не ограничен

```bsl
ВЫБРАТЬ
    РеализацияТоваровУслуг.Товары .(
        Номенклатура,
        Количество,
        Цена,
        Сумма
    )
ИЗ
    Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
```

Виртуальная таблица:

```bsl
ВЫБРАТЬ
    Остатки.Товар КАК Товар,
    Остатки.Склад КАК Склад,
    Остатки.КоличествоОстаток КАК Остаток
ИЗ
    РегистрНакопления.ТоварныеЗапасы.Остатки(&Период, Товар = &Товар) КАК Остатки
```

Была создана виртуальная таблица "`Остатки`", с заданными параметрами, которые вычисляются при выполнении запроса.

#### ЗНАЧЕНИЕ()

Данный оператор позволяет подставлять в запрос **предопределенные** значения. По какой-то причине, чтобы использовать предопределенные значения, такие как Перечисления, предопределенные реквизиты Документов, Справочников и т.д., необходимо использовать оператор `ЗНАЧЕНИЕ()`.

```bsl
ВЫБРАТЬ * ИЗ РегистрСведений.КадровыеПеремещения
ГДЕ ПричинаИзмененияСостояния = ЗНАЧЕНИЕ(Перечисление.ПричиныИзмененияСостояний.Увольнение)
```

Если не использовать `ЗНАЧЕНИЕ()`, то сравнение, в данном случае, будет происходить не с ссылкой а со значением перечисления, а с текстовым представлением идентификатора перечисления.

#### Оператор `ПОДОБНО / LIKE`



## ВЫБОР КОГДА ТОГДА

https://programmist1s.ru/kak-pomestit-tablitsu-v-zapros-1s/

Существует инструмент для выборки данных в зависимости от некоторых условий.

Синтаксис:

```bsl
ВЫБРАТЬ
    ВЫБОР
        КОГДА <УСЛОВИЕ> ТОГДА <ВЫРАЖЕНИЕ1>
        [КОГДА <УСЛОВИЕ> ТОГДА <ВЫРАЖЕНИЕ2>]
        [ИНАЧЕ <ВЫРАЖЕНИЕ3>]
    КОНЕЦ [КАК <ПСЕВДОНИМ>]
ИЗ ИСТОЧНИК
```

#Syntax/1С/Выбор

## Группировка


### Оператор `ИМЕЮЩИЕ`

Аналогичен оператору `ГДЕ` и позволяет использовать агрегатную функцию в выражении условия. но применяется к результату группировки. Оператор `ГДЕ` использовать для группировок нельзя.

## Соединения и объединения


https://helpme1s.ru/soedineniya-v-zaprosax-v-1s-8-v-primerax

### `ОБЪЕДИНЕНИЕ`

>У объединяемых таблиц должно быть одинаковое количество полей.

>Поля двух объединяемых запросов, в одном и том же порядке должны иметь одинаковые типы для сохранения целостности, но это не является требованием. Если типы полей будут разными, то при объединении запросов, объединенное поле будет иметь составной тип данных и хранить одно значение поля из двух запросов. При этом потерь данных не происходит.

```bsl
Выбрать Наименование ИЗ Справочник.Цвета

Объединить

Выбрать Калорийность ИЗ Справочник.Номер
```


```

```

| Наименование |
| ------------ |
| 30           |
| 31           |
| 44           |
| 59           |
| 89           |
| 216          |
| Белый        |
| Желтый       |
| Зеленый      |

По умолчанию, все полностью одинаковые строки из разных запросов попадают в объединенную выборку только 1 раз. То есть, если сделать объединение выборки с самой собой, то мы получим саму эту выборку.

Можно использовать объединение без этих оптимизаций с помощью оператора `ОБЪЕДИНИТЬ ВСЕ`

```BSL
ВЫБРАТЬ Наименование ИЗ Справочник.Цвета
ОБЪЕДИНИТЬ ВСЕ
ВЫБРАТЬ Наименование ИЗ Справочник.Цвета
```

| Наименование |
| ------------ |
| Белый        |
| Желтый       |
| Зеленый      |
| *Белый*        |
| *Желтый*       |
| *Зеленый*      |

Скачать картинки кругов Эйлера
https://bigdataschool.ru/wp-content/uploads/2020/12/sqljoin1.png

#Syntax/1С/Соединение

Соединения позволяют "склеивать" две выборки по определенному правилу. При выполнении соединения, нужно указывать по каким полям выборки будут "склеиваться" (`таблица1.Номер = таблица2.Номер`). Вцелом, все соединения схожи и отличаются лишь механизмом выбора строк.

### `ЛЕВОЕ СОЕДИНЕНИЕ`

Выбор **всех ненулевых** строк *левой* таблицы и выбор **всех** строк *правой* таблицы


### `ПРАВОЕ СОЕДИНЕНИЕ`

Выбор **всех ненулевых** строк *правой* таблицы и выбор **всех** строк *левой* таблицы

### `ВНУТРЕННЕЕ СОЕДИНЕНИЕ`

Выбор только ненулевых пар связанных строк

### `ПОЛНОЕ СОЕДИНЕНИЕ`

Выбор всех связанных строк

### Перекрестное соединение (Декартово произведение, каждый с каждым)

```BSL
//  -------------   ------------------------------
//  |   Люди    |   |   Характеристики           |
//  -------------   ------------------------------
//  |    ИМЯ    |   |   ИМЯ        |   ВОЗРАСТ   |
//  -------------   ------------------------------
//  |Алена      |   |   Алена      |    21       |
//  |Алефтина   |   |   Алефтина   |    18       |
//  |Владимир   |   |   Павел      |    25       |
//  |Владислав  |   |   Петр       |    30       |
//  |           |   |   Порфирий   |    50       |
//  -------------   ------------------------------

ВЫБРАТЬ
    Люди.Наименование КАК ИмяИзТаблицы1,
    Характеристики.Наименование КАК ИмяИзТаблицы2,
    Характеристики.Возраст КАК ВозрастИзТаблицы2
ИЗ
    Справочник.Люди КАК Люди,
    Справочник.Характеристики КАК Характеристики

// Результат перекрестного соединения:

// +---------------+---------------+-------------------+
// | ИмяИзТаблицы1 | ИмяИзТаблицы2 | ВозрастИзТаблицы2 |
// +---------------+---------------+-------------------+
// | Алена         | Алена         | 21                |
// | Алена         | Алефтина      | 18                |
// | Алена         | Павел         | 25                |
// | Алена         | Петр          | 30                |
// | Алена         | Порфирий      | 50                |
// | Алефтина      | Алена         | 21                |
// | Алефтина      | Алефтина      | 18                |
// | Алефтина      | Павел         | 25                |
// | Алефтина      | Петр          | 30                |
// | Алефтина      | Порфирий      | 50                |
// | Владимир      | Алена         | 21                |
// | Владимир      | Алефтина      | 18                |
// | Владимир      | Павел         | 25                |
// | Владимир      | Петр          | 30                |
// | Владимир      | Порфирий      | 50                |
// | Владислав     | Алена         | 21                |
// | Владислав     | Алефтина      | 18                |
// | Владислав     | Павел         | 25                |
// | Владислав     | Петр          | 30                |
// | Владислав     | Порфирий      | 50                |
// +---------------+---------------+-------------------+
```

Результатом перекрестного соединения являются все возможные комбинации строк из 1 и 2 таблиц. Поэтому количество строк такой выборки равно произведению количества строк 1-й таблицы и количества строк 2-й ($4\times5 = 20$)

### Комбинирование соединений

*Упомянуть вложенные соединения, генерируемые конструктором запросов*

## Сортировка

Оператор **`УПОРЯДОЧИТЬ ПО`** используется для сортировки результата запроса по определенным полям или выражениям. В выражениях подразумевается использование полей, на основе которых будет вычислятся значение, по котормоу будет происходить сортировка.

```bsl
УПОРЯДОЧИТЬ ПО
    поле1 [УБЫВ|ВОЗР]
    [, поле2 [УБЫВ|ВОЗР]...]
```

```bsl
// Для таблиц, для которых задано свойство иерархичности
// возможно упорядочивание в соответствии с иерархией.

// К примеру, сделаем вывод элементов из
// справочника "Номенклатура" в порядке
// их следования в иерархии справочника.

ВЫБРАТЬ Наименование ИЗ Справочник.Вкусы КАК Вкусы
УПОРЯДОЧИТЬ ПО Наименование ИЕРАРХИЯ
```

По умолчанию получаемые [[Основные понятия#^4f6aa9|записи]] таблиц БД неупорядочены. Порядок записей определяют особенности работы с данными в СУБД. При выполнении одного и того же запроса, строки и столбцы таблиц могут быть упорядочены по-разному

```bsl
ВЫБРАТЬ Наименование ИЗ Справочник.Цвета
ОБЪЕДИНИТЬ
ВЫБРАТЬ Наименование ИЗ Справочник.Вкусы
УПОРЯДОЧИТЬ ПО Наименование УБЫВ
```

При сортировке по полю запроса, которое может потенциально содержать NULL, следует учитывать, что в разных СУБД порядок сортировки по этому полю может отличаться. Лучше проверять, является ли поле NULL или нет. Если поле равно NULL, то его следует заменить на корректное значение, обозначающее отсутствие.

```bsl
ВЫБРАТЬ  
  СправочникНоменклатура.Ссылка КАК НоменклатураСсылка,  
  ЕСТЬNULL(ЗапасыОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток  
ИЗ  
  Справочник.Номенклатура КАК СправочникНоменклатура  
    ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.Запасы.Остатки КАК ЗапасыОстатки  
    ПО (ЗапасыОстатки.Номенклатура = СправочникНоменклатура.Ссылка)

УПОРЯДОЧИТЬ ПО  
  КоличествоОстаток
```

>При упорядочивании по ссылке сортировка будет производится по текстовому представлению ссылки, поэтому результат такой сортировки будет беспорядочным

Функция `ISNULL(field, value)` или `ЕСТЬNULL(поле, значение)` является аналогом NULL-объединения в C# (`val = val ?? 0;`). Если поле равно NULL, то возвращается второй параметр функции, если поле НЕ NULL, тогда вернется само поле.

**Если результаты запроса должны тем или иным образом отображаться пользователю, то**

- Упорядочивать результаты таких запросов необходимо по полям примитивных типов;
- Упорядочивание по полям ссылочных типов нужно заменять на упорядочивание по строковым представлениям этих полей.

В противном случае порядок следования строк будет выглядеть для пользователя случайным (необъяснимым)

Предложение `АВТОУПОРЯДОЧИВАНИЕ` позволяет включить режим автоматического формирования полей для упорядочивания результата запроса.

Автоупорядочивание работает по следующим принципам:
 
Если в запросе было указано предложение `УПОРЯДОЧИТЬ ПО`,
то каждая ссылка на таблицу, находящаяся в этом предложении,
будет заменена полями, по которым по умолчанию сортируется таблица
(для справочников это код или наименование, для документов – дата
документа). Если поле для упорядочивания ссылается на иерархический справочник,
то будет применена иерархическая сортировка по этому справочнику.

Если в запросе отсутствует предложение `УПОРЯДОЧИТЬ ПО`,
но есть предложение `ИТОГИ`, тогда результат запроса будет
упорядочен по полям, присутствующим в предложении
`ИТОГИ` после ключевого слова `ПО`, в той же последовательности и,
в случае если итоги рассчитывались по полям – ссылкам,
то по полям сортировки по умолчанию таблиц, на которые были ссылки. 

Если в запросе отсутствуют предложения `УПОРЯДОЧИТЬ ПО` и `ИТОГИ`,
но есть предложение `СГРУППИРОВАТЬ ПО`, тогда результат запроса
будет упорядочен по полям, присутствующим в предложении,
в той же последовательности и, в случае если группировка велась
по полям – ссылкам, то по полям сортировки по умолчанию таблиц,
на которые были ссылки. 

В случае же, если в запросе отсутствуют предложения и
`УПОРЯДОЧИТЬ ПО`, `ИТОГИ` и `СГРУППИРОВАТЬ ПО`, результат будет
упорядочен по полям сортировки по умолчанию для таблиц,
из которых выбираются данные, в порядке их появления в запросе.

В случае, если запрос содержит предложение `ИТОГИ`, каждый уровень
итогов упорядочивается отдельно.

В примере ниже мы сортируем по полю Ссылка и используем
ключевое слово `АВТОУПОРЯДОЧИВАНИЕ`. Система при этом
заменит поле Ссылка в секции `УПОРЯДОЧИТЬ ПО` на дату документа.

>Использование конструкции **`ПЕРВЫЕ`** совместно с конструкцией **`АВТОУПОРЯДОЧИВАНИЕ`** запрещено

[Source](https://helpme1s.ru/uporyadochivanie-v-zaprosax-v-1s-8-v-primerax)

## Итоги

Данное ключевое слово позволяет получать сводную информацию для указанного свойства объекта. Например, для каждого сотрудника можно найти суммарную зарплату.

```bsl
ВЫБРАТЬ * ИЗ Сотрудники
УПОРЯДОЧИТЬ ПО Сотрудник АВТОУПОРЯДОЧИВАНИЕ
ИТОГИ ПО Сотрудник
```

Данный запрос получает упорядоченные строки и формирует для каждого уникального сотрудника дополнительную запись, в которой должны содержаться все итоговые значения по Сотруднику. В данном случае никаких атрибутов для итогов не выбрано, поэтому будет отображен в доп. строках только Сотрудник.

Запрос с итогами по нескольким атрибутам

```bsl
ВЫБРАТЬ * ИЗ Сотрудники
УПОРЯДОЧИТЬ ПО Сотрудник АВТОУПОРЯДОЧИВАНИЕ
ИТОГИ СРЕДНЕЕ(Зарплата), СУММА(Зарплата) ПО Сотрудник
```

https://infostart.ru/1c/articles/1328254/

----


----

#1С #1С/Язык_запросов #Syntax/1С