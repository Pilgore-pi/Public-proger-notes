# HTTP-сервисы

Входящий HTTP-запрос имеет следущую структуру:

- URI отправителя (URL - это разновидность URI)
- Имя метода (`GET`, `POST`, `DELETE`, `HEAD`, `ANY` ...)
- Заголовки
- Параметры URL (обязательно)
- Параметры запроса (необязательно)
- Тело запроса (сами данные, необязательно)

HTTP-ответ имеет следующую структуру:

- Заголовки
- Код ответа
- Тело ответа

## Разновидности HTTP кодов:

#### 1xx — Информационные ответы
| Код | Описание |
|-----|---------|
| **100** | Сервер получил заголовки запроса, клиент может отправить тело запроса |
| **101** | Сервер согласен переключиться на другой протокол (например, WebSocket) |
| **103** | Сервер отправляет предварительные заголовки перед основным ответом |

#### 2xx — Успешные ответы

| Код | Описание |
|-----|---------|
| **200** | Запрос выполнен успешно |
| **201** | Создан новый ресурс (например, при POST-запросе) |
| **204** | Запрос обработан, но нет данных для возврата |
| **206** | Возвращена часть ресурса (например, при загрузке фрагментов) |

#### 3xx — Перенаправления

| Код | Описание |
|-----|---------|
| **301** | Постоянное перенаправление (ресурс перемещён навсегда) |
| **302** | Временное перенаправление (ресурс временно недоступен) |
| **304** | Ресурс не изменился с момента последнего запроса |

#### 4xx — Ошибки клиента

| Код     | Описание                                               |
| ------- | ------------------------------------------------------ |
| **400** | Некорректный запрос (например, неверный формат данных) |
| **401** | Неавторизованный доступ (требуется аутентификация)     |
| **403** | Запрещён доступ (права пользователя недостаточны)      |
| **404** | Ресурс не найден                                       |
| **429** | Слишком много запросов (ограничение скорости)          |

#### 5xx — Ошибки сервера

| Код     | Описание                                          |
| ------- | ------------------------------------------------- |
| **500** | Внутренняя ошибка сервера                         |
| **503** | Сервис временно недоступен (например, перегрузка) |
| **504** | Превышено время ожидания ответа от шлюза          |

**Примечание**: В таблицах приведены основные коды, наиболее часто используемые в разработке. Для полного списка можно обратиться к спецификациям **`RFC 7231`** и **`RFC 6585`**

# Создание HTTP-сервиса на практике

## 1. Установка сервера Apache или IIS

1. Необходимо скачать установщик веб-сервера [Apache](https://www.mediafire.com/download/utf9k7qf64equt6/apache_2.4.4-x64-openssl-1.0.1e.msi) 2.2 или 2.4, или Microsoft IIS. Чтобы приложение 1С смогло взаимодействовать с сервером, нужно, чтобы сервер был установлен как полноценное приложение, работающее в фоне

2. После установки сервера, нужно создать HTTP-сервис

## 2. Создание HTTP-сервиса

1. В дереве объектов конфигурации: `Общие > HTTP-сервисы` создаем новый сервис, например "ОперацииСНоменклатурой"

2. Задаем корневой URL, на основе которого будут формироваться все URL-запросы к нашему сервису

3. Создаем шаблон URL. Шаблон URL предназначен для обработки всех сетевых запросов, URL которых соответствует указанному шаблону. По умолчанию задан шаблон `/*`, позволяющий обрабатывать любые URL, содержащие корневой URL

4. Каждый шаблон URL может содержать несколько **методов**. Создадим один метод обработки, например "ПолучитьТовары".
    - Зададим тип HTTP-запроса **`GET`**, что соответствует запросу на получение информации от сервера.
    - Создадим обработчик метода, например "ПолучитьМатериалыСклада683".
    - Будет сгенерирован метод по шаблону:

```bsl
Функция ПолучитьМатериалыСклада683(Запрос)
	Ответ = Новый HTTPСервисОтвет(200);
	Возврат Ответ;
КонецФункции
```

> Шаблоны URL можно рассматривать как модуль, с набором сетевых методов. Платформа выступает в роли диспетчера. При получении запроса, она выполняет поиск по шаблонам, которые должны совпасть с URL полученного запроса, если ни одного шаблона подходящего запроса не найдено, то возвращается код ошибки

5. Добавляем код обработки, который получает данные и отправляет как ответ на запрос **GET**

> Все обработчики HTTP методов хранятся едином модуле HTTP-сервиса

```bsl
Функция ПолучитьМатериалыСклада683(Запрос)
	Ответ = Новый HTTPСервисОтвет(200);
	
	json = КакойтоОбщийМодуль.ПолучитьНоменклатуру(ТипНоменклатуры.Материалы, Склады.Склад683);
	
	// Задаем тело ответа как строку JSON, в которую были преобразованы данные
	// Тело запроса может содержать текст любого формата
	Ответ.УстановитьТелоИзСтроки(json, КодировкаТекста.UTF8);

	// Заголовок для браузера, чтобы он воспринимал текст в кодировке UTF-8
	Ответ.Заголовки.Вставить("charset", "utf-8");
	
	// Тип содержимого (JSON)
	Ответ.Заголовки.Вставить("Content-Type", "application/json");
	
	Возврат Ответ;
КонецФункции

/// КакойтоОбщийМодуль:

Функция ПолучитьНоменклатуру(тип, склад) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Номенклатура.Код КАК Код,
	|	Номенклатура.Наименование КАК Наименование,
	|	Номенклатура.Количество КАК Количество,
	|ИЗ
	|	Справочник.Номенклатура КАК Номенклатура
	|ГДЕ
	|   Номенклатура.Тип = &Тип и Номенклатура.Склад = &Склад";
	
	Запрос.УстановитьЗначениеПараметра("Тип", тип);
	Запрос.УстановитьЗначениеПараметра("Склад", склад);
    
	Выборка = Запрос.Выполнить().Выбрать();
    
	Массив = Новый Массив;
	Пока Выборка.Следующий() Цикл
		Структура = Новый Структура("Штрихкод, КодНоменклатуры, Наименование, Артикул");
		ЗаполнитьЗначенияСвойств(Структура, Выборка);
		Массив.Добавить(Структура);
	КонецЦикла;
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Массив);
	
	СтрокаJSON = ЗаписьJSON.Закрыть();
	Возврат СтрокаJSON;
	
КонецФункции
```

**Тело запроса может быть задано 3 способами:**

1. Из строки
2. Из файла
3. Из потока

**Как формируется сетевой запрос:**

> ~Корневой URL + Шаблон URL + URL запроса

## 3. Установка компонента публикации на веб-сервере

1. Для возможности публикации веб-сервиса ("Web-сервис" или "HTTP-сервис"), нужно, чтобы приложение 1С содержало компонент "Модули публикации на веб-сервере". Наличие этого компонента можно проверить, попытавшись начать публикацию веб-сервиса: `Администрирование > публикация на веб-сервере`. Если отображается ошибка с сообщением "Модули публикации веб-сервера не установлены", то потребуется выполнить следующий шаг:

2. Открыть приложение Windows "Программы и компоненты", найти приложение 1С и нажать "Изменить". Откроется мастер установки 1С, далее нужно просто включить компонент **Модули публикации на веб-сервере** и начать установку. Приложение 1С будет дополнено выбранными компонентами и теперь опция публикации веб-сервиса в конфигураторе будет доступна

## 4. Публикация сервиса

1. Необходимо открыть конфигуратор от имени администратора, чтобы иметь возможность публикации веб-сервиса

2. "Администрирование > Публикация на веб-сервере > Вкладка HTTP сервисы"

3. Задаем имя веб-сервера

4. Задаем каталог, в котором будет размещена публикация информационной базы. **Путь каталога не должен содержать кириллицу, если используется сервер Apache, доступны только символы ASCII**

> Разрядность веб сервера (x32 / x64) должна совпадать с разрядностью приложения 1С

5. Установить флажок `Публиковать HTTP севрисы по умолчанию` в ИСТИНА

6. Отметить в списке сервисов те, которые хотим опубликовать

7. Нажать кнопку `Опубликовать`

## 5. Использование

По URL `127.0.0.1/<ИМЯ_СЕРВИСА>` можно из браузера запустить приложение 1С:Предприятие 

Get запросы можно вызывать прямо из адресной строки браузера.

Запросы к опубликованному HTTP-сервису имеют следующую структуру URL:

```http
http://127.0.0.1/ИМЯ_ВЕБ_СЕРВЕРА/hs/КОРНЕВОЙ_URL/ИМЯ_МЕТОДА/
```

Или аналогичный адрес:

```http
http://localhost/ИМЯ_ВЕБ_СЕРВЕРА/hs/КОРНЕВОЙ_URL/ИМЯ_МЕТОДА/
```

`hs` - говорит о том, что используется "HTTP Service"

`ws` - используется для SOAP запросов

 #1C #1С/Интеграция #API/HTTP