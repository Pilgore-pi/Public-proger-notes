
> **СКД** — Система Компоновки Данных, позволяющая описывать, в каком виде необходимый набор информации будет показан пользователю. СКД позволяет описывать представление данных как декларативно (через интерфейс), так и императивно (программно)

* Главными преимуществами СКД является **возможность редактирования** отчета пользователем и **асинхронное формирование** отчета (без блокировки интерфейса приложения)
* СКД автоматически создает форму с базовым интерфейсом формирования отчета.
* СКД является полноценным типом макета, который может быть использован в отчете, справочнике, документе и регистрах.

СКД вне отчетов используется в нескольких сценариях:

* Для разделения данных на сегменты
* Для группировки данных
* Для оформления табличного документа ([infostart.ru](https://infostart.ru/1c/articles/1552862/))

СКД можно разработать 3 способами:

1. Через конфигуратор (основной способ)
2. Через код 1С
3. Через управлением структурой СКД как файлом XML. СКД физически — это XML файл со всей информацией о компоновке данных и элементов интерфейса.

Для СКД определен специальный мини-язык, который позволяет выполнять дополнительные операции над параметрами запросов данных. Данный язык поддерживает BSL (основной язык 1С). Можно создать функцию в общем модуле и вызывать в конструкторе СКД.

### Создание отчета

1. Создать новый объект метаданных типа "Отчет"
2. Отнести этот отчет в одну из подсистем
3. Нажать на кнопку "Открыть схему компоновки данных". Откроется конструктор специального макета СКД

>Отчет не хранит данные. Отчет формирует представление данных. Реквизиты и табличные части отчета не хранятся в БД

СКД имеет 2 ключевых элемента:

* **Схема компоновки (*СКД*)** — создается прогером (структура представляемых данных). Определяет, какие данные мы хотим получить, как мы группируем данные и какие параметры ожидаем. Работа со схемой компоновки в пользовательском режиме 1С, доступна только для «_толстого клиента_».
* **Настройки компоновки (*НКД*)** — устанавливаются пользователем или прогером (набор динамически изменяемых параметров). Определяет фильтрацию (отбор), упорядочивание, условное оформление, параметры получения и вывода данных. Если настройки задает прогер, то эти настройки будут использованы по умолчанию

## Конструктор СКД

При открытии окна работы с СКД можно увидеть 2 кнопки снизу слева, которые позволяют загрузить и выгрузить СКД как XML файл.

Вкладки:

* **[[#Вкладка "Наборы данных"|Наборы данных]]** — Выборки или совокупности выборок или внешних источников
* [[#Вкладка "Связи наборов данных"|Связи наборов данных]]
* [[#Вкладка "Вычисляемые поля"|Вычисляемые поля]]
* *[[#Вкладка "Ресурсы"|Ресурсы]]* — Вычисление переменных с помощью агрегатных функций (СУММА, СРЕДНЕЕ, МАКСИМУМ)
* [[#Вкладка "Параметры"|Параметы]]
* [[#Вкладка "Макеты"|Макеты]]
* [[#Вкладка "Вложенные схемы"|Вложенные схемы]]
* **[[#Вкладка "Настройки" (НКД)|Настройки]]** — Параметры отображения отчета. Могут настраиваться как разрабом, так и юзером.

Наложить условия в схеме компоновки можно несколькими способами:

- Указать **условия на уровне запроса** – жесткий отбор, который нельзя отключить в настройках компоновки. Если заданы параметры, они должны быть обязательно указаны, иначе будет выдано сообщение об ошибке.
- Указать **условие на уровне настроек компоновки** – отбор указывается на уровне настроек компоновки на закладке «_Отбор_». Пользователь может управлять такими отборами на уровне редактирования варианта отчета или пользовательских настроек. Если отбор указан, он будет добавлен в итоговый запрос макета компоновки (работа с настройками компоновки будет рассмотрена в следующей статье).
- Указать **условие в расширении языка запроса** – отбор указывается на закладке «_Параметры_» схемы компоновки или в настройках компоновки. Указание параметров не является обязательным. В итоговый запрос макета компоновки отбор будет включен только в том случае, если он задан

Если в качестве запроса используется пакет запросов, отбор, указанный в настройках компоновки будет применяться ко всем запросам пакета, если это возможно.

#### Вкладка "Наборы данных"

[Источник](https://infostart.ru/1c/articles/1095405/)

Здесь определяются данные, на основе которых будет составлен отчет.

Наборы данных могут быть разных видов:

##### 1. Запрос к БД — получение инфы с помощью языка запросов

* Количество выходных полей у всех объединяемых запросов должно совпадать;
* Ключевое слово `ИТОГИ` использовать нельзя, так как итоги формируются на уровне схемы, а не запроса

##### 2. Объект данных — внешний источник данных (таблица значений, файл, БД, сетевой запрос)

Пример кода для передачи внешних данных процессору компоновки

```bsl
ТЗ = новый ТаблицаЗначений;

// ...
ВнешниеНаборы = новый Структура;
ВнешниеНаборы.Вставить("ИмяНабораДанных", ТЗ);
ПроцессорКомпоновки = новый ПроцессорКомпоновкиДанных();
ПроцессорКомпановки.Инициализировать(МакетКомпоновки, ВнешниеНаборы); 
```

Имя набора данных должно соответствовать имени, заданному в схеме компоновки, а имена колонок таблицы значений – наименованиям полей в схеме.

##### 3. Объединение данных — объединение нескольких наборов данных

* Набор реквизитов у подчиненных наборов данных ограничен
* Объединение можно производить для наборов данных, которые имеют разное количество выходных полей

У подчиненных наборов отсутствуют следующие реквизиты:

- Автозаголовок,
- Роль,
- Выражения представления и упорядочивания,
- Проверка иерархии,
- Оформление,
- Параметры редактирования.

Поля объединяемых наборов с одинаковым значением реквизита «_Путь_» сворачиваются в одно. Автоматической группировки строк по полям с одинаковым реквизитом «_Путь_» - не происходит.

Поля с разными значениями реквизита «_Путь_», образуют отельные поля в итоговом наборе.

Из выше сказанного можно сделать вывод, **не должно быть четкого соответствия между количеством и последовательностью полей объединяемых наборов**. Но, если нам нужно, чтобы какие-либо значения из двух наборов объединились в одну колонку, это также возможно, путем указанием одного и того же реквизита «_Путь_».

>Если создать несколько наборов данных и не объединять их, то результирующей выборкой будет Декартово произведение всех столбцов из разных наборов данных.

#### Вкладка "Связи наборов данных"

Для настройки соединения наборов предназначена специальная закладка конструктора схемы компоновки «_Связи наборов данных_»

Соединение двух наборов выполняется по аналогии с соединением таблиц в запросе. На закладке «_Связи наборов данных_», по аналогии с конструктором запросов можно выбрать наборы данных и поля наборов (выражения), по которым необходимо выполнить соединение.

* Вид соединения по умолчанию всегда «_ЛЕВОЕ ВНЕШНЕЕ_». Источником связи выступает основной набор данных, приемником связи – подчиненный.
* Выполнять соединение можно только для наборов данных верхнего уровня. То-есть, наборы данных, которые входят в наборы «_Объединения_» соединять нельзя.



#### Вкладка "Вычисляемые поля"

#### Вкладка "Ресурсы"

Это переменные, полученные выполнением агрегатных функций, например, `Сумма()`, `Максимум()`, `Среднее()`, `Минимум()` или функция, определенная прогером.

Вкладки:

* `Поле` — поле, к которому применяется агрегатная операция
* `Выражение` — агрегатная функция (предопределенная или созданная прогером)
* `Рассчитывать по ...` — позволяет задать, для какого набора полей нужно выполнять агрегатную операцию.

Если необходимых полей, которые могут стать ресурсами нет, то можно просто добавить в выборку константу и присвоить ей необходимый псевдоним.

```bsl
ВЫБРАТЬ 1 КАК ОбщееКоличество ИЗ ИсточникДанных
```

#### Вкладка "Параметры"

Здесь определяются параметры, подставляемые в запрос или параметры, используемые для настройки отчета. Параметры могут задаваться автоматически, если установлен флаг `Автозаполнение` во владке `Набооры данных`.

Можно явно указывать параметры в самом запросе

**Вкладка `Доступные значения`**


**Вкладка `Ограничение доступности` (булеан)**

Позволяет сделать настройку определенных параметров недоступной для пользователя (значение `Истина` означает недоступность)

При установке недоступности для автоматически сгенерировнных параметров может быть нарушена логика отбора данных. Поэтому, в некоторых случаях, требуется явно задать, как будут вычисляться недоступные параметры (например, через задание Выражения)

**Вкладка `Параметры редактирования`**

* **Маска** (преимущественно для строковых типов)
* **Связать параметр с другим параметром**. Например, с контрагентом могут быть связаны договоры. Таким образом можно настроить отображение только договором, связанных с этим контрагентом.
* **Параметры выбора** (преимущественно для ссылок). Выборка из объекта метаданных (какие поля нам нужны)
* **Форма выбора** (преимущественно для ссылок). Какая форма выбора будет использована
* **Формат редактирования**. Можно задать формат с помощью конструктора форматов.

Чтобы параметры отображались по умолчанию для пользователя нужно открыть `Свойства элемента пользовательских настроек` и нажать галочку `Включать в пользовательские настройки`. Если рассматриваемый параметр доступен для пользователя, но параметр не включен в пользовательские настройки, то пользователь не увидит этот параметр на форме, но сможет его самостоятельно отобразить через вкладку `Ещё`

#### Вкладка "Макеты"

#### Вкладка "Вложенные схемы"


### Далее

* ##### [[03 НКД|Настройки компоновки данных]]
* ##### [[04 СКД - Оптимизация|Оптимизация СКД]]

#1С #1С/Конфигурация #1С/Конфигурация/Макеты #1С/СКД