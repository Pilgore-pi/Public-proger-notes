## Содержание

1. [[#Модули на уровне приложения|Модули на уровне приложения]]
    - [[#Модуль приложения|Модуль приложения]]
    - [[#Модуль внешнего соединения|Модуль внешнего соединения]]
    - [[#Модуль сеанса|Модуль сеанса]]
2. [[#Общие модули|Общие модули]]
3. [[#Модули объектов конфигурации|Модули объектов конфигурации]]
    - [[#Модули объектов конфигурации|Модуль менеджера]]
    - [[#Модуль объекта|Модуль объекта]]
    - [[#Модуль команды|Модуль команды]]
    - [[#Модуль формы|Модуль формы]]
4. [[#Что могут содержать модули]]

**Модуль** — это объект конфигурации, представляющий собой файл с кодом. Модули могут быть определены в разных областях видимости: на уровне приложения, на уровне конфигурации, на уровне объекта, формы объекта и т. д.

Модуль может содержать 3 типа сущностей кода:

- Глобальная переменная (на уровне модуля)
- Процедура
- Функция

Процедуры и функции могут содержать переменные, выражения и управляющие конструкции, а также вызов других процедур и функций

Принято логически разделять модуль на области:

- раздел объявления переменных
- раздел процедур и функций
- раздел основной программы

## Области видимости (контекст)

Можно выделить следующие виды контекстов, существующих в "1С:Предприятии 8":

 - **Глобальный контекст**, доступный во всех остальных контекстах, состоит из следующих частей:

    - свойства, методы и события глобального контекста (например, свойство **РабочаяДата**),
    - системные перечисления и системные наборы значений (например, **КодВозвратаДиалога** и **Символы**).

 - **В контексте модуля приложения** (или модуля внешнего соединения) доступны экспортируемые процедуры и функции общих модулей

 - **В контексте общего модуля** доступны экспортируемые процедуры и функции других общих модулей. В этом контексте недоступны экспортируемые переменные, процедуры и функции модуля приложения

 - **В контексте модуля прикладного объекта** есть доступ к реквизитам и табличным частям объекта, а также его методам и событиям. Например, в модуле документа **РасходнаяНакладная** доступны реквизиты документа и его табличные части, можно вызывать методы документа и обрабатывать события

 - **В контексте модуля формы** доступны реквизиты формы, а также ее свойства, методы и события. Если у формы назначен основной реквизит, то в модуле формы становятся доступны свойства и методы прикладного объекта, используемого в качестве основного реквизита, а также экспортируемые переменные, процедуры и функции модуля этого прикладного объекта.

Необходимо помнить правила видимости экспортируемых переменных, процедур и функций различных модулей:

1. В общем модуле недоступны экспортируемые переменные, процедуры и функции модуля приложения (модуля внешнего соединения).
2. В модуле приложения (модуле внешнего соединения) доступны экспортируемые процедуры и функции общих модулей.
3. В общих модулях доступны экспортируемые процедуры и функции других общих модулей.
4. В модулях прикладных объектов и модулях форм доступны экспортируемые переменные, процедуры и функции модуля приложения (модуля внешнего соединения), а также экспортируемые процедуры и функции общих модулей.
5. Если у формы назначен основной реквизит, то контекст модуля формы содержит дополнительные свойства и методы, связанные с основным реквизитом. Например, в модуле формы элемента справочника **Номенклатура** доступны свойства и методы объекта **СправочникОбъект.Номенклатура**.

## Модули на уровне приложения

### Модуль приложения

Модуль приложения предназначен для настройки клиентского приложения и обработки событий на уровне приложения, таких как:

- `ПередНачаломРаботыСистемы`
- `ПриНачалеРаботыСистемы`
- `ПередЗавершениемРаботыСистемы`
- `ОбработкаПолученияФормыВыбораПользователейСистемыВзаимодействия`

### Модуль внешнего соединения

Предназначен для обработки начала и окончания работы системы в режиме внешнего соединения ([[01 COM в 1С#COM-соединения|COM-соединения]]), а также для описания методов, которые должны быть доступны для внешнего приложения или неглобальных общих модулей с установленным флагом `Внешнее соединение`

Если конфигурация запускается не в режиме клиентской сессии, а через COM-соединение, то вместо модуля приложения используется модуль внешнего соединения, который в конфигурации может быть **только один**

Объекты 1С:Предприятия, доступные извне через [[01 COM в 1С#COM-соединения|COM-соединение]]:

- Экспортируемые переменные и методы модуля внешнего соединения
- Экспортируемые процедуры/функции общих модулей (общий модуль со свойством **`Внешнее соединение = ИСТИНА`**)
- Включение и исключение модулей целиком с помощью установки свойств общих модулей
- Включение и исключение фрагментов общих модулей с помощью препроцессора
- Глобальный контекст 1С:Предприятия 8

Объекты, жестко связанные с клиентским приложением недоступны через [[01 COM в 1С#COM-соединения|COM-соединение]] (ТекстовыйДокумент, ТабличныйДокумент, ...)

Модуль существует только в сессии внешнего соединения. В данном режиме характерно полное отсутствие пользовательского интерфейса

### Модуль сеанса

Модуль по управлению текущим сеансом для конкретного пользователя

>Модуль сеанса может содержать только определения процедур и функций

>Модуль сеанса не может содержать экспортируемых методов, но может использовать методы из общих модулей

Модуль предназначен для настройки параметров, связанных с текущим сеансом работы приложения и текущим пользователем.

Существует только 1 обработчик событий для данного модуля: `УстановкаПараметровСеанса`

Модуль сеанса всегда исполняется в привилегированном режиме в кластере серверов 1С:Предприятия 8

## Общие модули

Содержат в себе код, который доступен в глобальной области видимости, однако, ***чтобы использовать переменные и методы модуля в другом модуле, необходимо добавить модификатор `Экспорт` к сущности кода***. Это правило работает для всех модулей.

Общие модули предназначены для использования в качестве наборов полезных функций, доступных на уровне всей конфигурации.

В общих модулях не принято выделять область "Основная программа", общие модули не предназначены для хранения прикладной логики. Общие модули — это как библиотеки с определенным набором функций.

Свойства общего модуля как объекта конфигурации:

| Свойство                                                  | Тип          | Описание                                                                                                                                                                                                                                                                                                                                       |
| --------------------------------------------------------- | ------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`Глобальный`**                                          | Булево       | Если общий модуль является глобальным, то все его экспортные методы доступны из глобального контекста. Если `Глобальный = ЛОЖЬ`, то вместо, непосредственно, методов, в глобальном контексте создается общедоступное свойство с именем общего модуля *только для чтения*. Обращаясь к этому свойству, можно вызывать все его экспортные методы |
| **`Клиент`**                                              | Булево       | доступен вызов с клиента                                                                                                                                                                                                                                                                                                                       |
| **`Сервер`**                                              | Булево       | доступен вызов с сервера                                                                                                                                                                                                                                                                                                                       |
| **`Внешнее соединение`**                                  | Булево       | доступен для вызова через COM-соединение                                                                                                                                                                                                                                                                                                       |
| **`Вызов сервера`**                                       | Булево       | Определяет, доступен ли вызов серверных процедур со стороны клиента. Всегда `ЛОЖЬ`, если `Сервер = ЛОЖЬ`                                                                                                                                                                                                                                       |
| **`Привелегированный`**                                   | Булево       | Режим привелегий предоставляет полный доступ модуля к ИБ. Всегда `ЛОЖЬ`, если `Сервер = ЛОЖЬ`. Если `Привелегированный = ИСТИНА`, то `Сервер = ИСТИНА`, `Клиент = ЛОЖЬ`                                                                                                                                                                        |
| **`Повторное использование возвращаемых значений`** (Кэш) | Перечисление | Определяет способ кэширования результатов методов. Всегда "`Не использовать`", если `Глобальный = ИСТИНА`                                                                                                                                                                                                                                      |

**`Повторное использование возвращаемых значений`** может иметь 3 состояния:

- `Не использовать`: кэширования не происходит
- `На время вызова`: ???
- `На время сеанса`: кэш хранится на время сеанса, но не более 5-20 минут при неиспользовании кэшируемых данных

Кэширование нужно применять только для ресусроемких операций, которые выполняются часто.
Также стоит применять кэширование только, если вероятность необходимости вычисления одних и тех же данных с одними и теми же входными данными достаточно большая.

>Кэшируемые данные (результаты работы методов) нельзя изменять, так как это может привести к непредвиденным сбоям в работе программы. Поэтому лучше возвращать фиксированные массивы и структуры, которые доступны только для чтения.

Кэширование работает в рамках одного сеанса

Кэширование не сработает, если один из параметров кэшируемого метода является сложным объектом. Допустимы только эти примитивные типы:

- `Неопределено`
- `Null`
- `Булево`
- `Дата`
- `Строка`
- `Число`
- `Ссылка` 

Никаких структур, таблиц значений, объектов и т.п.

Общие модули бывают 2 типов:

* Глобальные: методы становятся доступны без указания названия модуля
* Неглобальные: С клиента могут быть доступны экспротные переменные

## Модули объектов конфигурации

#### Модуль менеджера

Предназначен для создания логики по работе с объектом конфигурации на уровне типа, то есть все методы работают одинаково для всех экземпляров объектов и не обладают контекстом этих экземпляров.

Пример использования **экспортной** функции из модуля менеджера

```bsl
СуммаНДС = Документы.НарядЗаказ.РассчитатьСтоимостьИзделий();
```

#### Модуль объекта

Модуль объекта предназначен для:

- Обработки событий, связанных с текущим экземпляром объекта (например `ПриЗаписи`)
- Создание методов на уровне экземпляра объекта
- Создание дополнительных свойств объекта (полей в модуле)

Пример использования в модуле формы:

```bsl
СканЗагруженПравильно = РеквизитФормыВЗначение(Объект).ПроверитьПравильностьЗагрузкиСкана();
```

#### Модуль команды

Для команд определен встроенный обработчик команды:

```bsl
&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды) //...
```

Этот обработчик срабатывает при активации команды и выполняется на клиенте.

#### Модуль формы

Данный модуль предназначен для обработки событий и логики формы

## Что могут содержать модули

| Модуль                     | Глобальные переменные | Метод &НаСервере | Метод &НаКлиенте |
| -------------------------- | --------------------- | ---------------- | ---------------- |
| Модуль приложения          | да                    | да               | да               |
| Модуль внешнего соединения |                       | да               | нет              |
| Модуль сеанса              |                       | да               | нет              |
| Общий модуль               | нет                   | настраивается    | настраивается    |
| Модуль менеджера           |                       | да               | нет              |
| Модуль объекта             | да                    | да               | нет              |
| Модуль команды             | нет                   | да               | да               |
| Модуль формы               | да                    | да               | да               |


#1С #1С/Конфигурация #1С/Язык_программирования #COM