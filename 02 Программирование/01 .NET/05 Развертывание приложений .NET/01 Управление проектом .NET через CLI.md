
> **.NET CLI (Command Line Interface)** — это кроссплатформенный API, позволяющий управлять приложениями .NET через терминал (Bash, Batch, PowerShell)

Доступ к API происходит через команду **`dotnet`**

Создание консольного C\# приложения:

```bash
### Создание проекта с именем "MyApp"
dotnet new console -n MyApp

### Сборка проекта "MyApp"
dotnet build MyApp

### Запуск приложения
dotnet run --project MyApp

### Публикация приложения в режиме Release
dotnet publish MyApp -c Release
```

### Создание своего терминального API

Чтобы приложение можно было запускать из любого места в терминале, нужно сделать его доступным в системном **[[04 Переменные среды PATH|PATH]]**. Это можно сделать 2 способами:

#### 1. Универсальный способ

Скомпилированный файл приложения нужно скопировать в одну из директорий, указанных в переменной окружения **[[04 Переменные среды PATH|PATH]]** (например, `C:\Program Files\YourApp` или `/usr/local/bin`).

#### 2. Регистрация приложения как инструмента через .NET CLI

1. В файле проекта `.csproj` нужно добавить свойство `PackAsTool` со значением `true`:

```xml
<PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net9.0</TargetFramework>
    <PackAsTool>true</PackAsTool>
</PropertyGroup>
```

2. Далее, нужно скомпилировать проект:
   
```bash
dotnet pack --configuration Release
```
   
3. Затем задать приложение .NET как глобальный инструмент терминала

```bash
dotnet tool install --global YourAppName --version <version>
```

Теперь приложение будет доступно из любой директории.

> Таким образом, можно разрабатывать любые приложения без использования IDE. Все, что необходимо — установить .NET (в случае C#)

https://www.youtube.com/watch?v=sa3XsvSiMtk&ab_channel=NickChapsas

https://www.youtube.com/watch?v=aTDUY66tlxk&ab_channel=NickChapsas

## Релиз проекта dotnet

### Команда `dotnet publish`

```bash
dotnet publish [project] <parameter-list>
```

| Параметр              | Описание                                                                                         | Пример использования                           |
| --------------------- | ------------------------------------------------------------------------------------------------ | ---------------------------------------------- |
| `[project]`           | Путь к проекту (.csproj) для публикации. Если не указан, используется текущая директория.        | `dotnet publish MyApp.csproj`                  |
| `-c, --configuration` | Конфигурация сборки (например, Debug или Release). По умолчанию - Debug.                         | `-c Release`                                   |
| `-f, --framework`     | Целевой фреймворк (Target Framework Moniker), например `net6.0`, `net7.0`.                       | `-f net7.0`                                    |
| `-r, --runtime`       | Идентификатор целевой платформы (Runtime Identifier, RID), например `win-x64`, `linux-x64`.      | `-r win-x64`                                   |
| `--self-contained`    | Публикация с включением .NET Runtime (true/false). По умолчанию true, если указан `-r`.          | `--self-contained true`                        |
| `-o, --output`        | Папка для вывода опубликованных файлов. По умолчанию `bin/<Configuration>/<Framework>/publish/`. | `-o ./publish`                                 |
| `--no-build`          | Не выполнять сборку перед публикацией (используется, если сборка уже сделана).                   | `--no-build`                                   |
| `--no-restore`        | Не выполнять восстановление пакетов NuGet перед публикацией.                                     | `--no-restore`                                 |
| `-p:<NAME> = <VALUE>` | Установить свойство MSBuild, например `PublishSingleFile` или `PublishTrimmed`.                  | `-p:PublishSingleFile=true`                    |
| `-v, --verbosity`     | Уровень детализации вывода: `quiet`, `minimal`, `normal`, `detailed`, `diagnostic`.              | `-v minimal`                                   |
| `--force`             | Принудительно разрешить все зависимости, даже если предыдущий restore успешен.                   | `--force`                                      |
| `--nologo`            | Отключить вывод логотипа .NET SDK.                                                               | `--nologo`                                     |
| `--manifest`          | Указать файл манифеста для публикации.                                                           | `--manifest manifest.xml`                      |
| `--source`            | Указать источник пакетов NuGet для восстановления.                                               | `--source https://api.nuget.org/v3/index.json` |
| `--version-suffix`    | Задать суффикс версии при публикации.                                                            | `--version-suffix beta`                        |
| `--disable-parallel`  | Отключить параллельную сборку проектов.                                                          | `--disable-parallel`                           |

Папка вывода по умолчанию: `bin/<конфигурация>/<фреймворк>/publish/`

Можно использовать профили публикации `.pubxml` через свойство `-p:PublishProfile=ProfileName`

Переходим в каталог с проектом `.cproj`:

```bash
cd C:\...\MyProject\
dotnet publish -r win-x64 -c Release /p:PublishSingleFile=true --self-contained true
```

#### Профили публикации

Профили публикации - это файлы конфигурации `.pubxml`, которые упрощают и автоматизируют процесс публикации .NET-приложений. Они позволяют сохранить настройки публикации (например, целевой путь, конфигурацию, параметры развертывания) и использовать их многократно, не вводя заново каждый раз.

Файл хранится в папке проекта `Properties/PublishProfiles/`.

- Профиль может содержать специфичные для среды данные, например, идентификаторы подписок Azure.

- Может содержать конфиденциальные данные (пароли и т.п.). Такие данные, обычно, хранятся отдельно в файлах `.pubxml.user` и не добавляются в систему контроля версий.

##### Зачем нужны профили публикации?

- Позволяют создавать несколько конфигураций публикации для одного проекта (например, публикация в папку, на сервер IIS, в Azure)

- Удобно переключаться между разными целями и параметрами публикации

- Упрощают автоматизацию и интеграцию с CI/CD

Пример файла `.pubxml`

```xml
<Project>
    <PropertyGroup>
        <Configuration>Release</Configuration>
        <Platform>Any CPU</Platform>
        <PublishDir>C:\PublishFolder\</PublishDir>
        <PublishProtocol>FileSystem</PublishProtocol>
        <TargetFramework>net6.0</TargetFramework>
        <RuntimeIdentifier>win-x64</RuntimeIdentifier>
        <SelfContained>true</SelfContained>
        <PublishSingleFile>false</PublishSingleFile>
    </PropertyGroup>
</Project>
```

### Публикация приложения Dotnet

> **Публикация** — это процесс создания готовой версии приложения с применением оптимизаций и отключением неиспользуемых зависимостей

#### Существует несколько режимов публикации приложения:

**По расположению выпуска приложения:**

- Локально на компьютере
- Публикация на удаленном сервере

**По структуре файлов приложения:**

- Portable~
- Self-Contained~
- Framework dependent~

**Объединение всех файлов приложения в один файл имеет несколько преимуществ:**

* Удобство использования
* Простое перемещение между устройствами и внутри одного устройства
* Не нужно ничего дополнительно устанавливать

**И недостатков:**

* Большой вес, так как необходимо хранить библиотеки .Net
* Однофайловое приложение всегда зависит от ОС и архитектуры процессора, поэтому требуется делать однофайловое развертывание для каждой нужной конфигурации.
* Все файлы отладки типа PDB (Program Data Base) не входят в упакованный файл по умолчанию

Свойства проекта .Net в Visual Studio 2022:
При нажатии на название проекта в "Обозревателе решений", откроется XML-файл настроек проекта. Внутри тега "PropertyGroup" определены свойства проекта.

* `TargetFramework` — версия .Net, на которую ориентируется проект
* `Nullable` (true/false) — Nullable-контекст на уровне проекта
* `ApplicationManifest` — 
* `OutputType` — тип запускаемого приложения (Exe, WinExe, Library)
* `SelfContained` — определяет, является ли приложение автономным (true) или зависимым от фреймворка .Net.
* `RuntimeIdentifier` — определяет целевую ОС и процессор. При указании данного свойства SelfContained определяется как "true" по умолчанию

## Пример развертывания однофайлового приложения

1. Добавить в свойства проекта, в тег `PropertyGroup` свойство `PublishSingleFile` и установить его в `true`, в противном случае публикация приложения будет стандартной с файлами развертывания и установки.
2. Открыть контекстное меню проекта и выбрать "Publish/Опубликовать"
![[VS_Publish.png]]
Если ранее однофайловых публикаций не выполнялось, то нужно будет выбрать "Целевой объект: Папка" и указать путь к публикации. Затем, нужно изменить целевую архитектуру процессора, конфигурацию приложения и платформу .Net. Далее можно пользоваться готовым профилем.

3. Нажать "Опубликовать"

#Dotnet/Applications #API/Terminal